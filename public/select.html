<!DOCTYPE html>
<html>

<head>

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Park Place</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css" integrity="sha384-PsH8R72JQ3SOdhVi3uxftmaW6Vc51MKb0q5P2rRUpPvrszuE4W1povHYgTpBfshb"
    crossorigin="anonymous">
  <link rel="stylesheet" type='text/css' href='assets/css/style.css'>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  <style>
  </style>
  <script type="text/javascript" src="https://maps.google.com/maps/api/js?key=AIzaSyDhIiIOhvGAfKAPnFtIiEiHJoqc__ui79w&libraries=geometry&sensor=false&language=en"></script>
</head>

<body>
  <div class="container-fluid">
    <div class="span12" id="form">
      <div class="row">

        <div class="form-group ion-text col-sm-3 pr-0" id="sidebar">
          <div class='alert alert-primary bg-primary'>
            <h2 class='text-light text-center display-5'>PARK PLACE</h2>
            <!-- <img src='assets/images/car.png' id='carIcon'> -->
          </div>
          <div id="results">


            <div id="initial">Click Icons
              <img src='assets/images/pin.png' id='pin'> on the map to select your
              <strong>Parking Spot!</strong>
            </div>
            <div id="distance"></div>
            <div id="time"></div>
            <div id="address"></div>
            <div id="price"></div>


          </div>
          <div id="book-data">
            <!-- Contains all data to be shown after clicking on submit/book -->
            <div>
              <label for="inputEmail">Email address</label>
              <input type="email" class="form-control" id="inputEmail" aria-describedby="email" placeholder="Enter email">
              <small id="email" class="form-text text-muted">We'll never share your email (except to make $$)</small>
            </div>
            <hr>
            <p>Address of parking spot:
              <br>
              <div id="add"></div>
            </p>

          </div>

          <button type="submit" id="submit" class="btn btn-primary">Choose this Spot</button>
          <button type="submit" id="book" class="btn btn-primary">Book this Spot</button>

        </div>

        <div class="form-group ion-text col-sm-9">
          <div class='embed-responsive embed-responsive-4by3'>
            <div id='map' class='embed-responsive-item'>

            </div>
          </div>
        </div>

      </div>
      <!-- end row -->
    </div>
  </div>



  <script>
    $(document).ready(function () {
      $("#book-data").hide();
      $("#submit").hide();
      $("#book").hide();

      // var locations = [
      //  [32.238,  -110.95014,"$4/hr"],
      //  [32.233,  -110.9511323,"$12/hr"],
      //  [ 32.24, -110.951624,"$3/hr"],
      //  [ 32.2429, -110.952235,"$4.5/hr"],
      //  [ 32.239, -110.9521235678,"$5.5/hr"],
      //  [ 32.236, -110.9521235678,"$6/hr"],
      //  [ 32.244, -110.9501235678,"$7/hr"]
      //   ];
      var locations = [];
      $.get("/space-info", function (data) {
        console.log(data);
        for (var i = 0; i < data.length; i++) {
          if (data[i].availability === true) {
            locations.push(data[i]);
          }
        }

        loadmap();

      });
      var map = new google.maps.Map(document.getElementById('map'), {
        zoom: 14.75,
        center: { lat: 32.2319, lng: -110.9501 }, //Destination cordinates
        mapTypeId: google.maps.MapTypeId.HYBRID,   //to add lables in satellite map
        labels: true

      });
      var infowindow = new google.maps.InfoWindow();
      var geocoder = new google.maps.Geocoder;
      var marker, i;
      var address;

      function loadmap() {
        for (i = 0; i < locations.length; i++) { //for loop for all markers/parking spots in DB
          console.log(locations[i]);

          marker = new google.maps.Marker({
            position: new google.maps.LatLng(locations[i].location_lat, locations[i].location_lng),
            map: map,
            label: {
              text: "$" + locations[0].price + "/hr",
              color: 'white',

            }

          });

          google.maps.event.addListener(marker, 'click', (function (marker, i) {//on clicking on marker

            return function () {
              var a = new google.maps.LatLng({ lat: 32.2319, lng: -110.9501 }); //destination
              var b = new google.maps.LatLng({ lat: locations[i].location_lat, lng: locations[i].location_lng }); //lat long of marker
              geocoder.geocode({ 'location': b }, function (results) { //geocoder gives address

                infowindow.setContent(results[0].formatted_address);
                infowindow.open(map, marker);
                var distance = Math.round((google.maps.geometry.spherical.computeDistanceBetween(a, b)) * 3.28 * 100) / 100;
                //calculate distance between two points
                var time = Math.round(((distance) / 80.4672) * 100) / 100;
                //Source: https://www.quora.com/What-is-the-assumed-walking-speed-in-Google-Mapss-time-estimates
                //on click empty all divs and reload data from clicked marker
                $('#distance').empty(" ");
                $('#address').empty(" ");
                $('#time').empty(" ");
                $('#price').empty(" ");
                $('#time').empty(" ");
                $('#initial').hide(" ");
                $("#submit").show();
                $('#distance').append("<strong>" + "Distance from University of Arizona: " + "</strong>" + "<br/>" + distance + " meters" + "<br/>" + "<br/>");
                $('#time').append("<strong>" + "Walk time to University of Arizona: " + "</strong>" + "<br/>" + time + " minutes" + "<br/>" + "<br/>");
                $('#address').append("<strong>" + "Address of Parking Spot: " + "</strong>" + "<br/>" + results[0].formatted_address + "<br/>" + "<br/>");
                $('#price').append("<strong>" + "Price of Parking Spot: " + "</strong>" + "<br/>" + "$" + locations[i].price + "/hr" + "<br/>" + "<br/>");
                //console.log(results);
                address = results[0].formatted_address;
              });
            }
          })(marker, i));

        }
      }//loadmap ends

      $("#submit").on("click", function handleFormSubmit(event) {
        event.preventDefault();
        $("#book-data").show();
        $("#results").hide();
        $("#book").show();
        $("#submit").hide();

        // Wont submit the post if we are missing a body or a title
        $("#add").append(address);

      });
      $("#book").on("click", function handleFormBook(event) {
        event.preventDefault();

      });
    });
  </script>



</body>

</html>